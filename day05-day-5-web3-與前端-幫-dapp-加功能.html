<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DAY 5｜Day 5 - Web3 與前端：幫 DApp 加功能 - Web3 全端工程師的技術養成之路</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Web3 全端工程師的技術養成之路</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="day-5day-5---web3-與前端幫-dapp-加功能"><a class="header" href="#day-5day-5---web3-與前端幫-dapp-加功能">DAY 5｜Day 5 - Web3 與前端：幫 DApp 加功能</a></h1>
<ul>
<li>原文：https://ithelp.ithome.com.tw/articles/10317865</li>
<li>發佈時間：2023-09-14 01:08:14</li>
</ul>
<h2 id="章節內容"><a class="header" href="#章節內容">章節內容</a></h2>
<h3 id="1-未分章內容"><a class="header" href="#1-未分章內容">1. 未分章內容</a></h3>
<p>昨天我們的 DApp 已經有簡單的讀取功能，因此今天會開始實作較進階的讀取跟簡單的寫入的功能，也就是發送交易。例如錢包餘額現在可以顯示 ETH 的餘額，而在 Day 3 時已經透過測試鏈上的 Uniswap 獲得一些 UNI 幣，因此第一個目標是把這個幣的餘額顯示出來，再來就可以實際送出一個轉出 UNI 幣的交易到區塊鏈上。</p>
<h3 id="2-uni-幣的原理"><a class="header" href="#2-uni-幣的原理">2. UNI 幣的原理</a></h3>
<p>UNI 幣本質上背後就是一個智能合約，可以先把智能合約理解成跑在區塊鏈上的程式。只是 UNI Token 的智能合約符合 <a href="https://docs.openzeppelin.com/contracts/4.x/erc20">ERC20</a> 標準，這個標準是最廣泛被應用來實作代幣的標準（像以太坊上常見的 USDT, USDC, DAI, UNI 都是），<a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#IERC20">這裡</a>可以看到 ERC20 定義了什麼 function 以及相關細節：</p>
<p>[code]
totalSupply()
balanceOf(account)
transfer(to, amount)
allowance(owner, spender)
approve(spender, amount)
transferFrom(from, to, amount)</p>
<p>[/code]</p>
<p>今天我們不會細講太多關於 ERC20 以及智能合約的細節，不過可以大致猜到幾個 function 的作用： <code>totalSupply()</code> 代表這個代幣的總發行量， <code>balanceOf(account)</code> 可以拿到一個地址的代幣餘額， <code>transfer(to, amount)</code> 可以指定要把我的代幣轉多少給誰。其他 function 今天還不會用到，有興趣的讀者可以先自行研究。</p>
<p>所以只要 UNI 的智能合約實作了這些 function，他就可以被稱為符合 ERC20 標準的智能合約，並且就支援一個代幣所需要的基本功能。讀到這邊大家可能也理解到了在以太坊上只有 ETH 是以太坊的「原生」代幣，其他代幣都是用智能合約實作出來的，透過把各個地址的代幣餘額紀錄在智能合約上，來模擬一個代幣的帳本。有些人會用 Coin 跟 Token 來區分這兩個概念，Coin 指的是這個區塊鏈原生的幣，Token 則指的是在這個鏈上透過智能合約模擬出來的幣，例如可以說 Polygon 這條鏈的 Coin （原生代幣）是 MATIC，而在 Polygon 鏈的 <a href="https://polygonscan.com/token/0x7ceb23fd6bc0add59e62ac25578270cff1b9f619">ETH 幣</a>是 Token。</p>
<h3 id="3-取得-token-balance"><a class="header" href="#3-取得-token-balance">3. 取得 Token Balance</a></h3>
<p>要取得當下地址的 UNI Token Balance，我們需要用到 wagmi 的 <code>useContractRead</code> hook，可以用來讀取任意智能合約中 view function 的結果。所以首先需要用它來呼叫 <code>balanceOf(account)</code> 並帶入當下連接的錢包地址：</p>
<p>[code]
import { useContractRead } from "wagmi";</p>
<pre><code>const UNI_CONTRACT_ADDRESS = "0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984";
const NULL_ADDRESS = "0x0000000000000000000000000000000000000000";

// inside Profile()
const { data: balanceData } = useContractRead({
  address: UNI_CONTRACT_ADDRESS,
  abi: abi,
  functionName: "balanceOf",
  args: [address || NULL_ADDRESS],
});
</code></pre>
<p>[/code]</p>
<p>其中 <code>UNI_CONTRACT_ADDRESS</code> 指的是 UNI 這個代幣背後的智能合約，找到他的方式是在上次執行的 <a href="https://sepolia.etherscan.io/tx/0xe9e3ba1bd7a867782f5507ba492ceaef338b426575982f18a7fcd3d396e4482a">Swap 交易</a>中可以看到我收到的 UNI Token 數量，點進去就有他的<a href="https://sepolia.etherscan.io/address/0x1f9840a85d5af5bf1d1762f925bdaddc4201f984">合約地址</a>了</p>
<p><img src="images/day05-img001-b6ee41f847.png" alt="https://ithelp.ithome.com.tw/upload/images/20230914/20162294T58i4q2RuD.png" /></p>
<p>可以看到我們透過 <code>useContractRead</code> 呼叫這個合約的 <code>balanceOf</code> function 並帶入 <code>address</code> 參數（如果尚未連接錢包就先給他一個 0x0 的地址字串），就可以拿到 balance 資料。其中還有一個參數是 <code>abi</code>，這裡就要介紹到 <a href="https://www.alchemy.com/overviews/what-is-an-abi-of-a-smart-contract-examples-and-usage">ABI (Application Binary Interface)</a> 的概念。簡單來說他就是任何人要跟智能合約互動時的介面定義，就像 RESTful API 介面一樣，把這個介面的輸入跟輸出格式定義清楚，包含 function name、參數及型別、回傳值等等。為了跟 UNI Token Contract 互動並呼叫他的 function，需要先定義跟他互動的介面，長得像這樣：</p>
<p>[code]
const abi = [
{
inputs: [
{
internalType: "address",
name: "account",
type: "address",
},
],
name: "balanceOf",
outputs: [
{
internalType: "uint256",
name: "",
type: "uint256",
},
],
stateMutability: "view",
type: "function",
},
] as const;</p>
<p>[/code]</p>
<p>直接閱讀就能猜到大部分的意思，像是他定義清楚了 <code>balanceOf</code> 這個 function 的 input output 以及他是一個 view function（不會改變智能合約的狀態）。後面加上 <code>as const</code> 是因為這樣才能讓 Typescript 幫我們做 Type inference，從傳入 <code>useContractRead</code> 的 <code>functionName</code> , <code>abi</code>自動推斷出 <code>args</code> 跟 return value 的型別。最後就可以把拿到的 <code>balanceData</code> 顯示出來</p>
<p>[code]
{balanceData !== undefined &amp;&amp; <div>UNI Balance: {balanceData.toString()}</div>}</p>
<p>[/code]</p>
<p>結果如下：</p>
<p><img src="images/day05-img002-d1309a24bd.png" alt="https://ithelp.ithome.com.tw/upload/images/20230914/20162294laGok7OOFF.png" /></p>
<h3 id="4-token-decimals"><a class="header" href="#4-token-decimals">4. Token Decimals</a></h3>
<p>上述的程式碼跑出來會看到 UNI Token Balance 是一個很大的數字，但其實我只有 0.000043 個 UNI 而已。這背後其實是因為智能合約上儲存的都是 Token Balance 乘上 10 的幾次方的結果，這就是為什麼 ABI 裡 <code>balanceOf</code> 定義的 output 類別才是 <code>uint256</code>而不是浮點數。這也跟以太坊當時設計 EVM 的考量有關，因為浮點數的計算常有精度誤差，這對極嚴格要求在所有電腦上都要有一致性的區塊鏈來說，原生支援浮點數計算會有比較高的風險。</p>
<p>至於要乘上 10 的幾次方，ERC20 合約也有一個 <code>decimals()</code> function 可以用來查詢這個數值，方便大家把智能合約上讀出來的數字轉換成讓人類可以理解的數字，因此我們補上對應的 ABI 跟 contract read，就能算出最終要顯示的結果：</p>
<p>[code]
import { formatUnits } from "viem";</p>
<pre><code>// abi definition
{
  inputs: [],
  name: "decimals",
  outputs: [
    {
      internalType: "uint8",
      name: "",
      type: "uint8",
    },
  ],
  stateMutability: "view",
  type: "function",
}

// inside Profile()
const { data: decimals } = useContractRead({
  address: UNI_CONTRACT_ADDRESS,
  abi: abi,
  functionName: "decimals",
});
const uniBalance =
  balanceData &amp;&amp; decimals ? formatUnits(balanceData, decimals) : undefined;

// inside return
{uniBalance &amp;&amp; &lt;div&gt;UNI Balance: {uniBalance}&lt;/div&gt;}
</code></pre>
<p>[/code]</p>
<p>很多代幣的 decimals 會是 18，因為以太坊原生的 ETH 最小單位也是 10^-18 ETH，也被稱為 wei。不過也有蠻多 decimals 是 6 的 token，所以每次都從鏈上查詢是最精準的。這樣就能顯示正確的餘額了！</p>
<p><img src="images/day05-img003-b6e5b9fbc1.png" alt="https://ithelp.ithome.com.tw/upload/images/20230914/20162294aH24KhFLfJ.png" /></p>
<h3 id="5-送出交易"><a class="header" href="#5-送出交易">5. 送出交易</a></h3>
<p>再來是送出 Transfer UNI Token 的交易，會用到 <code>useContractWrite</code> hook 搭配智能合約上的 <code>transfer(to, amount)</code> function 達成。一樣先補上需要的 import 跟 ABI：</p>
<p>[code]
import { useContractWrite } from "wagmi";</p>
<pre><code>// abi
{
	inputs: [
	  {
	    internalType: "address",
	    name: "recipient",
	    type: "address",
	  },
	  {
	    internalType: "uint256",
	    name: "amount",
	    type: "uint256",
	  },
	],
	name: "transfer",
	outputs: [
	  {
	    internalType: "bool",
	    name: "success",
	    type: "bool",
	  },
	],
	stateMutability: "nonpayable",
	type: "function",
},
</code></pre>
<p>[/code]</p>
<p>並從 <code>useContractWrite</code> 拿到需要的 write function 跟資料呈現在畫面上，其中第一個參數是要轉去的地址，可以在 Metamask 中再新增一個錢包地址來使用，第二個參數則是要轉出的數量（也就是在智能合約上紀錄的值，型別是 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt">bigint primitive</a>）</p>
<p>[code]
// inside Profile()
const {
data: txData,
isLoading,
isSuccess,
write: sendUniTx,
} = useContractWrite({
address: UNI_CONTRACT_ADDRESS,
abi,
functionName: "transfer",
args: ["0xE2Dc3214f7096a94077E71A3E218243E289F1067", 100000n],
});</p>
<pre><code>// inside return
{uniBalance &amp;&amp; (
  &lt;&gt;
    &lt;div&gt;UNI Balance: {uniBalance}&lt;/div&gt;
    &lt;button onClick={() =&gt; sendUniTx()}&gt;Send UNI&lt;/button&gt;
    {isLoading &amp;&amp; &lt;div&gt;Check Your Wallet...&lt;/div&gt;}
    {isSuccess &amp;&amp; &lt;div&gt;Transaction Hash: {txData?.hash}&lt;/div&gt;}
  &lt;/&gt;
)}
</code></pre>
<p>[/code]</p>
<p>實際跑起來點擊 Send UNI 後，就會跳出 Metamask 的視窗，確認後交易就成功送出了！畫面上會顯示對應的 Transaction Hash</p>
<p><img src="images/day05-img004-5e27406f1f.png" alt="https://ithelp.ithome.com.tw/upload/images/20230914/20162294yb8vuBKuBX.png" /></p>
<p>再來就可以到 Sepolia Etherscan 上查看交易結果，在這個網址後面貼上 Tx Hash 即可：<code>https://sepolia.etherscan.io/tx/</code></p>
<p><img src="images/day05-img005-99d0bc5440.png" alt="https://ithelp.ithome.com.tw/upload/images/20230914/20162294MmEURkA4cE.png" /></p>
<p>交易成功上鏈後，重新整理畫面也可以看到顯示的 UNI Token Balance 已經有減少了。</p>
<h3 id="6-補充說明"><a class="header" href="#6-補充說明">6. 補充說明</a></h3>
<p>這裡補充一些前面沒有提到的細節。首先是如何知道合約的 ABI 是什麼？這個其實可以到 Etherscan 的智能合約頁面，點 Contract tab 後往下拉就可以看到合約的完整 ABI。UNI 智能合約的網址在<a href="https://sepolia.etherscan.io/address/0x1f9840a85d5af5bf1d1762f925bdaddc4201f984#code">這裡</a></p>
<p><img src="images/day05-img006-a7ba46bf02.png" alt="https://ithelp.ithome.com.tw/upload/images/20230914/201622945oaUFxRyof.png" /></p>
<p>整份複製下來也可以，他就會包含所有這個合約定義的 function，只是今天的內容為了簡單就沒有把整份 ABI 複製出來。</p>
<p>再來如果有讀者實際把程式跑起來，可能會注意到按下 Send UNI 到跳出錢包中間會有一兩秒的延遲，而這是因為 wagmi 需要計算當下送出交易要用多少 gas fee、設定的 nonce 要是多少等等（未來會更深入講解）。為了提升使用體驗 wagmi 建議使用 <a href="https://wagmi.sh/react/prepare-hooks/usePrepareContractWrite">usePrepareContractWrite</a> hook 來預先抓好這些資料。詳細可以參考 <a href="https://wagmi.sh/react/prepare-hooks">wagmi prepare hooks</a> 介紹跟這個 hook 的用法。</p>
<p>最後一個是如果在送出交易時馬上到 Sepolia Etherscan 上查看這筆 Tx Hash 的資料，可能會發現大概過了 10 秒到 30 秒左右這筆才會成功上鏈，因為從送出交易到上鏈中間需要經過礦工的驗證、按照手續費排序、打包進區塊等等，才能真正在區塊鏈上確認。為了呈現這個狀態 wagmi 也提供 <a href="https://wagmi.sh/react/hooks/useWaitForTransaction">useWaitForTransaction</a> hook 來查詢一個 Tx Hash 的最新狀態，包含是否已確認、交易成功還是失敗等等。這樣才能知道何時要重拉 UNI Token Balance 資料，以在畫面上呈現最即時的餘額。</p>
<h3 id="7-小結"><a class="header" href="#7-小結">7. 小結</a></h3>
<p>今天我們學到了更多關於智能合約的知識，以及和智能合約互動的方式，包含讀跟寫的操作，完整程式碼放在<a href="https://github.com/a00012025/ironman-2023-web3-fullstack/tree/main/frontend/day5">這裡</a>。明天我們會介紹一個好用的 library 來大幅提升連接錢包的體驗，也就是 RainbowKit。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="day04-day-4-web3-與前端-實作第一個-dapp.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="day06-day-6-web3-與前端-rainbowkit-wallet-connect.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="day04-day-4-web3-與前端-實作第一個-dapp.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="day06-day-6-web3-與前端-rainbowkit-wallet-connect.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
